const ZapparCamera=pc.createScript("zapparCamera");ZapparCamera.attributes.add("Front Facing Camera",{type:"boolean",default:!1,description:"Should front camera be used"}),ZapparCamera.attributes.add("Mirror Mode",{type:"string",enum:[{None:"none"},{CSS:"css"},{Poses:"poses"}],default:"none",description:"How the scene and camera is mirrored/flipped"}),ZapparCamera.attributes.add("Camera Pose",{type:"string",enum:[{Default:"default"},{Anchor:"anchor"},{Attitude:"attitude"}],default:"default",description:"Pose mode of the tracked content"}),ZapparCamera.prototype.initialize=function(){if(this.canvas=this.app.graphicsDevice.canvas,this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),!this.gl)throw new Error("no gl");this.cameraPoseMatrix=new pc.Mat4,this.mirror=!1,ZapparCamera.prototype.pipeline=new Zappar.Pipeline,this.pipeline.glContextSet(this.gl);const getActiveSource=()=>this["Front Facing Camera"]?ZapparCamera.prototype.source.user:ZapparCamera.prototype.source.rear;this.app.on("zappar:camera",(e=>{const{message:a,userFacing:t}=e;"flip"===a&&(void 0===t?(this["Front Facing Camera"]=!this["Front Facing Camera"],getActiveSource().start()):(this["Front Facing Camera"]=t,getActiveSource().start()))})),ZapparCamera.prototype.source={user:new Zappar.CameraSource(this.pipeline,Zappar.cameraDefaultDeviceID(!0)),rear:new Zappar.CameraSource(this.pipeline,Zappar.cameraDefaultDeviceID(!1))},Zappar.permissionRequestUI().then((e=>{this.app.fire("zappar:camera",{message:"permission_granted",granted:e}),e?getActiveSource().start():Zappar.permissionDeniedUI()})),document.addEventListener("visibilitychange",(()=>{const e=getActiveSource();if("hidden"===document.visibilityState)e.pause();else e.start()})),this.initializeBackground()},ZapparCamera.prototype.update=function(){if(!this.pipeline||!this.app.autoRender)return;this.pipeline.frameUpdate();const e=Array.from(this.pipeline.cameraPoseDefault());this.cameraPoseMatrix.set(e);const{width:a,height:t}=this.canvas;switch(this["Mirror Mode"]){case"none":this.mirror=!1,this.canvas.style.transform="";break;case"poses":this.mirror=!0,this.canvas.style.transform="";break;case"css":this.mirror=!1,this.canvas.style.transform="scaleX(-1)";break;default:throw new Error("Unknown mirror type")}this.pipeline.processGL(),this.pipeline.frameUpdate();const r=this.pipeline.cameraModel(),i=Array.from(Zappar.projectionMatrixFromCameraModel(r,a,t)),n=(new pc.Mat4).set(i),s=this.entity.camera;s&&(s.calculateProjection=e=>{e.copy(n);const a=n.data;s.horizontalFov=!1,s.fov=2*Math.atan(1/a[5])*180/Math.PI,s.aspectRatio=a[5]/a[0],s.farClip=a[14]/(a[10]+1),s.nearClip=a[14]/(a[10]-1)},this.updateBackgroundTexture(this.pipeline))},ZapparCamera.prototype.initializeBackground=function(){this.backgroundPlane=new pc.Entity,this.backgroundPlane.addComponent("render",{type:"plane"}),this.backgroundPlane.setLocalEulerAngles(-90,0,0),this.entity.addChild(this.backgroundPlane),this.texture=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8}),this.material=new pc.Material,this.material.cull=pc.CULLFACE_FRONT,this.backgroundPlane.render.material=this.material;const e={attributes:{position:pc.SEMANTIC_POSITION,texcoord:pc.SEMANTIC_TEXCOORD0},vshader:"\n            precision highp float;\n            attribute vec3 position;\n            attribute vec2 texcoord;\n            uniform mat4 texTransform;\n\n            uniform mat4 matrix_model;\n            uniform mat4 matrix_viewProjection;\n\n            varying vec2 uv;\n\n            void main(void)\n            {\n                uv = (texTransform * vec4(texcoord.xy, 0., 1.)).xy;\n\n                gl_Position = matrix_viewProjection * matrix_model * vec4(position, 1.0);\n            }",fshader:"\n            precision highp float;\n            varying vec2 uv;\n            uniform sampler2D uCameraTexture;\n\n            void main(void)\n            {\n                vec4 color = texture2D(uCameraTexture, uv);\n                gl_FragColor = color;\n            }"},a=new pc.Shader(this.app.graphicsDevice,e);this.material.shader=a,this.material.setParameter("uCameraTexture",this.texture)},ZapparCamera.prototype.updateBackgroundTexture=function(e){const{aspectRatio:a,fov:t,farClip:r}=this.entity.camera;this.backgroundPlane.setPosition(0,0,-(r-Number.MIN_VALUE));const i=this.backgroundPlane.getPosition().length(),n=t*Math.PI/180,s=i*Math.tan(n/2)*2,o=s*a;this.backgroundPlane.setLocalScale(o,1,s),this.texture.impl&&this.texture.impl._glTexture?this.texture.impl._glTexture=e.cameraFrameTextureGL():this.texture._glTexture=e.cameraFrameTextureGL();const p=e.cameraFrameTextureMatrix(this.app.graphicsDevice.width,this.app.graphicsDevice.height,this.mirror);this.material.setParameter("texTransform",p)};const zapparImageTracker=pc.createScript("zapparImageTracker");zapparImageTracker.attributes.add("Target Image",{type:"asset",assetType:"binary",description:"Image Target file (.zpt) "}),zapparImageTracker.attributes.add("Target Upright",{type:"boolean",default:!0,description:"Offset rotations for upright targets"}),zapparImageTracker.attributes.add("Zappar Camera",{type:"entity",description:"Zappar Camera (Drag from hierarchy)"}),zapparImageTracker.attributes.add("QuestID",{type:"number"}),zapparImageTracker.attributes.add("FocusEntity",{type:"entity",description:"Object to show when focus"}),zapparImageTracker.prototype.initialize=function(){if(!this["Zappar Camera"])throw new Error("Zappar Camera attribute undefined - Please link camera entity to attribute.");if(this.Camera=this["Zappar Camera"].script.zapparCamera,this.pipeline=this.Camera.pipeline,this.imageTracker=new Zappar.ImageTracker(this.pipeline),this.imageTracker.onNewAnchor.bind((a=>{console.log("New anchor has appeared:",a.id)})),this.imageTracker.onVisible.bind((a=>{this.app.fire("zappar:visible",!0,this.QuestID)})),this.imageTracker.onNotVisible.bind((a=>{this.app.fire("zappar:visible",!1,this.QuestID)})),!this["Target Image"])throw new Error("No target image found in entity assets");const a=this["Target Image"].resource;this.imageTracker.loadTarget(a)},zapparImageTracker.prototype.update=function(){const a=this["Target Upright"]?90:0;this.imageTracker.visible.forEach((e=>{const{cameraPoseMatrix:r}=this.Camera,t=Array.from(e.pose(r.data,this.Camera.mirror)),i=(new pc.Mat4).set(t);this.entity.setEulerAngles(i.getEulerAngles().x+a,i.getEulerAngles().y,i.getEulerAngles().z),this.entity.setPosition(i.getTranslation())}))};const ZapparFaceTracker=pc.createScript("zapparFaceTracker");ZapparFaceTracker.attributes.add("Max Faces",{type:"number",default:1,description:"The maximum number of faces the tracker will look for"}),ZapparFaceTracker.attributes.add("Target Upright",{type:"boolean",default:!0,description:"Offset rotations for upright targets"}),ZapparFaceTracker.attributes.add("Zappar Camera",{type:"entity",description:"Zappar Camera (Drag from hierarchy)"}),ZapparFaceTracker.prototype.initialize=function(){if(!this["Zappar Camera"])throw new Error("Zappar Camera attribute undefined - Please link camera entity to attribute.");this.Camera=this["Zappar Camera"].script.zapparCamera,this.faceTracker=new Zappar.FaceTracker(this.Camera.pipeline),this.faceTracker.loadDefaultModel().then((()=>{console.log("face tracking model loaded")})),this.faceTracker.onNewAnchor.bind((a=>{console.log("New anchor has appeared:",a.id)})),this.faceTracker.onVisible.bind((a=>{console.log("Anchor is visible:",a.id)})),this.faceTracker.onNotVisible.bind((a=>{console.log("Anchor is not visible:",a.id)})),this.faceTracker.maxFaces=this["Max Faces"]},ZapparFaceTracker.prototype.update=function(){const{cameraPoseMatrix:a}=this.Camera,e=this["Target Upright"]?90:0;this.faceTracker.visible.forEach((r=>{const t=Array.from(r.pose(a.data,this.Camera.mirror)),i=(new pc.Mat4).set(t);this.entity.setEulerAngles(i.getEulerAngles().x+e,i.getEulerAngles().y,i.getEulerAngles().z),this.entity.setPosition(i.getTranslation())}))};const zapparInstantTracker=pc.createScript("zapparInstantTracker");zapparInstantTracker.attributes.add("Placement Button",{type:"entity",description:"Button which locks tracking state"}),zapparInstantTracker.attributes.add("Anchor Camera Offset",{type:"number",default:[0,0,-5],array:!0,description:"Offset the target by this vector while its camera anchored"}),zapparInstantTracker.attributes.add("Zappar Camera",{type:"entity",description:"Zappar Camera (Drag from hierarchy)"}),zapparInstantTracker.prototype.initialize=function(){if(!this["Zappar Camera"])throw new Error("Zappar Camera attribute undefined - Please link camera entity to attribute.");this.Camera=this["Zappar Camera"].script.zapparCamera,this.pipeline=this.Camera.pipeline;const t=this["Placement Button"];if(!t||!t.element)throw new Error("No placement button attached to instant tracker.");const placed=()=>{this.hasPlaced=!0,t.enabled=!1};t.element.on("mousedown",placed,this),t.element.on("touchstart",placed,this),this.instantTracker=new Zappar.InstantWorldTracker(this.pipeline)},zapparInstantTracker.prototype.update=function(){const t=this["Anchor Camera Offset"];this.hasPlaced||this.instantTracker.setAnchorPoseFromCameraOffset(...t);const{cameraPoseMatrix:a}=this.Camera,{anchor:e}=this.instantTracker,r=Array.from(e.pose(a.data,this.Camera.mirror)),n=(new pc.Mat4).set(r);this.entity.setEulerAngles(n.getEulerAngles().x,n.getEulerAngles().y,n.getEulerAngles().z),this.entity.setPosition(n.getTranslation())};const ZapparFaceLandmark=pc.createScript("zapparFaceLandmark");ZapparFaceLandmark.attributes.add("Landmark Target",{type:"string",enum:[{"Eye (Left)":"EYE_LEFT"},{"Eye (Right)":"EYE_RIGHT"},{"Ear (Left)":"EAR_LEFT"},{"Ear (Right)":"EAR_RIGHT"},{"Nose (Bridge)":"NOSE_BRIDGE"},{"Nose (Tip)":"NOSE_TIP"},{"Nose (Base)":"NOSE_BASE"},{"Lip (Top)":"LIP_TOP"},{"Lip (Bottom)":"LIP_BOTTOM"},{"Mouth (Center)":"MOUTH_CENTER"},{Chin:"CHIN"},{"Eyebrow (Left)":"EYEBROW_LEFT"},{"Eyebrow (Right)":"EYEBROW_RIGHT"}],default:"none",description:"Which face feature the landmark should track to"}),ZapparFaceLandmark.attributes.add("Face Tracker",{type:"entity",description:"Face Tracker (Drag from hierarchy)"}),ZapparFaceLandmark.attributes.add("Zappar Camera",{type:"entity",description:"Zappar Camera (Drag from hierarchy)"}),ZapparFaceLandmark.prototype.initialize=function(){const a=Zappar.FaceLandmarkName[this["Landmark Target"]];this.faceLandmark=new Zappar.FaceLandmark(a)},ZapparFaceLandmark.prototype.update=function(){if(!this["Zappar Camera"])throw new Error("Zappar Camera attribute undefined - Please link camera entity to attribute.");if(!this["Face Tracker"])throw new Error("Face Tracker attribute undefined - Please link face tracker entity to attribute.");const{faceTracker:a}=this["Face Tracker"].script.zapparFaceTracker,e=this["Zappar Camera"].script.zapparCamera,{pipeline:r}=e,t=e["Camera Pose"],i="poses"===e["Mirror Mode"];let n=r.cameraPoseDefault();switch(t){case"attitude":n=r.cameraPoseWithAttitude(i);break;case"anchor":{const e=a.anchors.values().next().value;e&&(n=r.cameraPoseWithOrigin(e.poseCameraRelative(i)));break}}a.visible.forEach((a=>{const e=(new pc.Mat4).set(Array.from(a.pose(n,i)));this.faceLandmark.updateFromFaceAnchor(a,i);const r=e.mul((new pc.Mat4).set(Array.from(this.faceLandmark.pose)));this.entity.setEulerAngles(r.getEulerAngles().x,r.getEulerAngles().y,r.getEulerAngles().z),this.entity.setPosition(r.getTranslation())}))};const ZapparFaceMesh=pc.createScript("zapparFaceMesh");ZapparFaceMesh.attributes.add("Face Tracker",{type:"entity",description:"Face Tracker (Drag from hierarchy)"}),ZapparFaceMesh.attributes.add("Zappar Camera",{type:"entity",description:"Zappar Camera (Drag from hierarchy)"}),ZapparFaceMesh.attributes.add("Fill mouth",{type:"boolean",default:!1,description:"Mesh fills mouth"}),ZapparFaceMesh.attributes.add("Fill eye (left)",{type:"boolean",default:!1,description:"Mesh fills eye"}),ZapparFaceMesh.attributes.add("Fill eye (right)",{type:"boolean",default:!1,description:"Mesh fills eye"}),ZapparFaceMesh.attributes.add("Mask",{type:"boolean",default:!1,description:"Occlude depth, do not render colors"}),ZapparFaceMesh.attributes.add("Full Head",{type:"boolean",default:!1,description:"Use full head mesh?"}),ZapparFaceMesh.attributes.add("material",{type:"asset",assetType:"material",description:"The material that the mesh uses"}),ZapparFaceMesh.prototype.initialize=function(){if(!this["Zappar Camera"])throw new Error("Zappar Camera attribute undefined - Please link camera entity to attribute.");if(!this["Face Tracker"])throw new Error("Face Tracker attribute undefined - Please link face tracker entity to attribute.");this.ZfaceMesh=new Zappar.FaceMesh;(this["Full Head"]?this.ZfaceMesh.loadDefaultFullHeadSimplified(this["Fill mouth"],this["Fill eye (left)"],this["Fill eye (right)"]):this.ZfaceMesh.loadDefaultFace(this["Fill mouth"],this["Fill eye (left)"],this["Fill eye (right)"])).then((()=>{const e=new pc.GraphNode,t=new pc.Model;t.graph=e;const a=pc.createMesh(this.app.graphicsDevice,Array.from(this.ZfaceMesh.vertices),{normals:Array.from(this.ZfaceMesh.normals),uvs:Array.from(this.ZfaceMesh.uvs)});let s;if(this.entity.removeComponent("model"),this.entity.addComponent("model"),this.Mask){let e=this.app.assets.find("Occluder");e?(s=e.resource,s.depthTest=!0,s.depthWrite=!0,s.blueWrite=!1,s.redWrite=!1,s.greenWrite=!1,s.alphaWrite=!1):(s=this.material.resource,console.warn('Zappar: Missing "Occluder material'))}else s=this.material.resource;const r=new pc.MeshInstance(a,s,e);t.meshInstances.push(r),this.entity.model&&(this.entity.model.model=t),this.entity.rotateLocal(0,180,0)})),this.faceTracker=this["Face Tracker"].script.zapparFaceTracker.faceTracker,this.Camera=this["Zappar Camera"].script.zapparCamera},ZapparFaceMesh.prototype.update=function(){this.faceTracker.visible.forEach((e=>{if(this.ZfaceMesh.updateFromFaceAnchor(e),this.entity.model&&this.entity.model.meshInstances[0]){const e=this.entity.model.meshInstances[0].mesh;e.setPositions(this.ZfaceMesh.vertices),e.setUvs(0,this.ZfaceMesh.uvs),e.setIndices(this.ZfaceMesh.indices),e.setNormals(this.ZfaceMesh.normals),e.update()}}))};const zapparBrowserUtil=pc.createScript("zapparBrowserUtil");zapparBrowserUtil.attributes.add("Mobile Only",{type:"boolean",default:!1,description:"Redirect users to mobile"}),zapparBrowserUtil.attributes.add("Compatibility Check",{type:"boolean",default:!1,description:"Perform compatability checks"}),zapparBrowserUtil.prototype.initialize=function(){this["Compatibility Check"]&&Zappar.browserIncompatible()&&(Zappar.browserIncompatibleUI(),this.app.autoRender=!1),this["Mobile Only"]&&(MobileOnly.isMobile()||(MobileOnly.showUI(),this.app.autoRender=!1))};var AnimationController=pc.createScript("animationController");AnimationController.prototype.initialize=function(){this.animation=this.entity.animation,this.allowedToHit=!1,this.animations={down:"Down.glb",up:"Up.glb",idle:"Idle.glb"},this.playing=!1,this.hideMoles(),this.app.on("game:start",(()=>{this.playing=!0})),this.app.on("game:end",(()=>{this.allowedToHit=!1,this.playing=!1,this.down(!1)})),this.eventEmitted=!1,this.animation.on("finished",(i=>{switch(i){case this.animations.down:this.up();break;case this.animations.up:this.idle();break;case this.animations.idle:this.down(!1)}})),this.respawnTime=1e4,this.idleTime=5e3,this.app.on("game:level",(i=>{this.respawnTime=i.respawnTime,this.idleTime=i.idleTime}))},AnimationController.prototype.hideMoles=function(){this.animation.play(this.animations.down),this.currentAnimation=this.animations.down,this.animation.currentTime=this.animation.duration-.05},AnimationController.prototype.down=function(i=!0){this.currentAnimation!==this.animations.down&&(i&&this.entity.children[0].sprite.play("explode"),this.animation.play(this.animations.down,.1),this.animation.speed=2,this.currentAnimation=this.animations.down,this.eventEmitted=!1,setTimeout((()=>{this.app.fire("game:sfx_descend"),this.allowedToHit=!1}),400))};const between=(i,t)=>Math.floor(Math.random()*(t-i+1))+i;AnimationController.prototype.up=function(){this.animation.speed=1,setTimeout((()=>{this.playing&&(this.allowedToHit=!0,this.animation.play(this.animations.up),this.currentAnimation=this.animations.up,this.eventEmitted=!1,this.app.fire("game:sfx_ascent"),setTimeout((()=>{this.down(!1)}),between(300,this.idleTime)))}),between(300,this.respawnTime))},AnimationController.prototype.idle=function(){this.animation.speed=1,this.animation.play(this.animations.idle),this.currentAnimation=this.animations.idle,this.eventEmitted=!1},AnimationController.prototype.update=function(i){this.timer+=i,this.playing?this.animation.currentTime!=this.animation.duration||this.eventEmitted||(this.eventEmitted=!0,this.animation.fire("finished",this.currentAnimation)):this.timer=0};var PickerRaycast=pc.createScript("pickerRaycast");PickerRaycast.prototype.initialize=function(){this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onClick,this);const t=this.app.touch;t&&(console.log("touch supported"),t.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this)),this.playing=!1,this.app.on("game:end",(()=>{this.playing=!1})),this.app.on("game:start",(()=>{this.playing=!0}))},PickerRaycast.prototype.updateFromScreen=function(t){const e=this.entity.camera.screenToWorld(t.x,t.y,this.entity.camera.nearClip),i=this.entity.camera.screenToWorld(t.x,t.y,this.entity.camera.farClip),a=this.app.systems.rigidbody.raycastFirst(e,i);this.playing&&null!==a&&(this.app.fire("game:picked_entity",a),a.entity.script.animationController.down())},PickerRaycast.prototype.onClick=function(t){this.updateFromScreen(t),t.event.preventDefault()},PickerRaycast.prototype.onTouchStart=function(t){this.updateFromScreen(t.touches[0]),t.event.preventDefault()};var Score=pc.createScript("score");Score.prototype.initialize=function(){let e=0;this.app.on("game:end",(()=>{e=0})),this.app.on("game:picked_entity",(i=>{const t=i.entity.script.animationController;t.allowedToHit?(t.allowedToHit=!1,e++,this.app.fire("game:sfx_hit")):(this.app.fire("game:sfx_miss"),e=0===e?0:--e),this.app.fire("game:score",e)}))};var Uicontroller=pc.createScript("uicontroller");Uicontroller.attributes.add("ScoreText",{type:"entity"}),Uicontroller.attributes.add("Instructions",{type:"entity"}),Uicontroller.attributes.add("InstructionsText",{type:"entity"}),Uicontroller.attributes.add("ContinueButton",{type:"entity"}),Uicontroller.attributes.add("GameController",{type:"entity"}),Uicontroller.attributes.add("Timer",{type:"entity"}),Uicontroller.attributes.add("TapToContinueText",{type:"entity"}),Uicontroller.attributes.add("ARInstructions",{type:"entity"}),Uicontroller.attributes.add("Level",{type:"entity"}),Uicontroller.prototype.initialize=function(){this.score=0,this.ScoreText.element.enabled=!1,this.Timer.element.enabled=!1,this.app.on("game:start",(()=>{this.ScoreText.element.enabled=!0,this.Timer.element.enabled=!0})),this.app.on("game:end",(()=>{this.TapToContinueText.element.text="(tap to retry)",this.InstructionsText.element.text=`\nYOU SCORED ${this.score}!\n\n\nTap on the moles\nwhen they appear to scare them away!\n`,this.ScoreText.element.enabled=!0,this.Timer.element.enabled=!1,this.ScoreText.element.enabled=!1,this.Instructions.enabled=!0,this.score=0,setTimeout((()=>{this.ContinueButton.element.enabled=!0,this.TapToContinueText.element.enabled=!0}),1500)})),this.app.on("game:score",(t=>{this.ScoreText.element.text=`SCORE:${t}`,this.score=t})),this.Level.enabled=!1,this.app.on("zappar:visible",(t=>{this.targetVisible=t,this.ARInstructions.enabled=!t,this.Level.enabled=t}));const onTap=()=>{this.targetVisible&&(this.ContinueButton.element.enabled=!1,this.TapToContinueText.element.enabled=!1,this.Instructions.enabled=!1,setTimeout((()=>{this.app.fire("game:start")}),500))};this.ContinueButton.element.on("mousedown",onTap,this),this.ContinueButton.element.on("touchstart",onTap,this)},Uicontroller.prototype.update=function(t){const e=this.GameController.script.timer.getRemainder();this.Timer.element.text=`${e}s`};var SoundController=pc.createScript("soundController");SoundController.prototype.initialize=function(){this.app.on("game:sfx_hit",(()=>{this.entity.sound.play("hit")})),this.app.on("game:sfx_miss",(()=>{this.entity.sound.play("miss")})),this.app.on("game:sfx_ascent",(()=>{this.entity.sound.play("ascent")})),this.app.on("game:sfx_descend",(()=>{this.entity.sound.play("descend")}))};var WindEffect=pc.createScript("windEffect");WindEffect.attributes.add("Resistance",{type:"number",default:100,description:"Resistance"}),WindEffect.prototype.initialize=function(){this.dx=0},WindEffect.prototype.update=function(t){this.dx+=.01+t;const e=Math.sin(this.dx)/this.Resistance,i=this.entity.getLocalEulerAngles();this.entity.setLocalEulerAngles(i.x+e,i.y+e,i.z+e)};let FollowPath=pc.createScript("followPath");FollowPath.attributes.add("pathRoot",{type:"entity",title:"Path Root"}),FollowPath.attributes.add("duration",{type:"number",default:10,title:"Duration Secs"}),FollowPath.attributes.add("startTime",{type:"number",default:0,title:"Start Time (Secs)",description:"Start the path from a specific point in time"}),FollowPath.prototype.initialize=function(){this.createPath(),this.on("attr:pathRoot",(function(t,i){t&&(this.createPath(),this.time=0)})),this.on("attr:time",(function(t,i){this.time=pc.math.clamp(this.startTime,0,this.duration)})),this.time=pc.math.clamp(this.startTime,0,this.duration),this.lookAt=new pc.Vec3,this.up=new pc.Vec3,this.flyingThrough=!0},FollowPath.prototype.update=function(t){let i;this.flyingThrough?(this.time+=t,this.time>this.duration&&(this.time-=this.duration),i=this.time/this.duration):i=this.pathSlider.value/this.pathSlider.max,this.entity.setPosition(this.px.value(i),this.py.value(i),this.pz.value(i)),this.lookAt.set(this.tx.value(i),this.ty.value(i),this.tz.value(i)),this.up.set(this.ux.value(i),this.uy.value(i),this.uz.value(i)),this.entity.lookAt(this.lookAt,this.up)},FollowPath.prototype.createPath=function(){let t=pc.CURVE_CARDINAL;this.px=new pc.Curve,this.px.type=t,this.py=new pc.Curve,this.py.type=t,this.pz=new pc.Curve,this.pz.type=t,this.tx=new pc.Curve,this.tx.type=t,this.ty=new pc.Curve,this.ty.type=t,this.tz=new pc.Curve,this.tz.type=t,this.ux=new pc.Curve,this.ux.type=t,this.uy=new pc.Curve,this.uy.type=t,this.uz=new pc.Curve,this.uz.type=t;let e=this.pathRoot.children,h=0,s=[],a=new pc.Vec3;for(s.push(0),i=1;i<e.length;i++){let t=e[i-1],o=e[i];a.sub2(t.getPosition(),o.getPosition()),h+=a.length(),s.push(h)}for(i=0;i<e.length;i++){let t=s[i]/h,a=e[i],o=a.getPosition();this.px.add(t,o.x),this.py.add(t,o.y),this.pz.add(t,o.z);let p=o.clone().add(a.forward);this.tx.add(t,p.x),this.ty.add(t,p.y),this.tz.add(t,p.z);let u=a.up;this.ux.add(t,u.x),this.uy.add(t,u.y),this.uz.add(t,u.z)}};var MoveLeftRight=pc.createScript("moveLeftRight");MoveLeftRight.attributes.add("clouds",{type:"entity",array:!0,default:["","","",""],title:"Number of clouds"}),MoveLeftRight.attributes.add("min_x",{type:"number",default:-.85}),MoveLeftRight.attributes.add("max_x",{type:"number",default:3.7,description:"Resistance"}),MoveLeftRight.attributes.add("speed",{type:"number",default:10}),MoveLeftRight.prototype.initialize=function(){},MoveLeftRight.prototype.normalize=function(t,e,i){let o=(t-e)/(i-e);return o-=.5,o=.5-Math.abs(o),o*=2,o},MoveLeftRight.prototype.update=function(t){let e=0;for(const i of this.clouds){e++;let o=e/10;const a=i.getLocalPosition();a.x<this.min_x?(a.x=this.max_x,i.setLocalPosition(a)):(a.x-=this.speed*o*t,i.setLocalPosition(a));let s=this.normalize(a.x,this.min_x,this.max_x);for(let t of i.model.meshInstances)t.setParameter("material_opacity",s)}};var Timer=pc.createScript("timer");Timer.attributes.add("GameLength",{type:"number",default:30}),Timer.prototype.initialize=function(){this.levels={easy:{respawnTime:1e4,idleTime:6e3},medium:{respawnTime:6e3,idleTime:4e3},hard:{respawnTime:3e3,idleTime:2500}},this.playing=!1,this.timer=0,this.app.on("game:start",(()=>{this.playing=!0})),this.app.on("game:end",(()=>{this.playing=!1}))},Timer.prototype.update=function(e){this.playing?(this.timer>35?this.app.fire("game:level",this.levels.hard):this.timer>15?this.app.fire("game:level",this.levels.medium):this.app.fire("game:level",this.levels.easy),this.timer+=e,this.timer>this.GameLength&&this.app.fire("game:end")):this.timer=0},Timer.prototype.getRemainder=function(){const e=this.GameLength-this.timer;return(e>0?e:0).toFixed(0)};var GameSystem=pc.createScript("gameSystem");GameSystem.attributes.add("item",{type:"entity",array:!0}),GameSystem.prototype.initialize=function(){GameSystem.instance=this,this.readyToScan=!1,this.cid=-1,this.score=[0,0,0,0],this.app.on("zappar:visible",((e,t)=>{console.log(e),e&&this.showQuest(t)}))},GameSystem.prototype.showQuest=function(e){this.readyToScan&&this.cid!==e&&(this.cid=e,QuestSystem.instance.ShowQuest(e))},GameSystem.prototype.getItem=function(e){this.item[e].enabled=!0,this.score[e]=1,console.log(this.score)},GameSystem.prototype.checkFusion=function(){this.score[0]+this.score[1]+this.score[2]+this.score[3]>=4?this.fusion():SceneManager.instance.s03.enabled=!0},GameSystem.prototype.clearQuestion=function(){this.cid=-1},GameSystem.prototype.fusion=function(){SceneManager.instance.s03.enabled=!1,SceneManager.instance.s06.enabled=!0},GameSystem.prototype.update=function(e){};var QuestData=pc.createScript("questData");QuestData.attributes.add("quests",{type:"json",array:!0,schema:[{name:"title",type:"string"},{name:"subtitle",type:"string"},{name:"q",type:"string"},{name:"a0",type:"string"},{name:"a1",type:"string"},{name:"a2",type:"string"},{name:"ans",type:"number"}]}),QuestData.prototype.initialize=function(){QuestData.instance=this},QuestData.prototype.update=function(t){};var QuestSystem=pc.createScript("questSystem");QuestSystem.attributes.add("title",{type:"entity"}),QuestSystem.attributes.add("subtitle",{type:"entity"}),QuestSystem.attributes.add("content",{type:"entity"}),QuestSystem.attributes.add("a1",{type:"entity"}),QuestSystem.attributes.add("a2",{type:"entity"}),QuestSystem.attributes.add("a3",{type:"entity"}),QuestSystem.attributes.add("submit",{type:"entity"}),QuestSystem.attributes.add("wrong",{type:"entity"}),QuestSystem.attributes.add("btnSelected",{type:"entity",array:!0}),QuestSystem.attributes.add("btnPress",{type:"entity",array:!0}),QuestSystem.attributes.add("btnResultOK",{type:"entity",array:!0}),QuestSystem.prototype.initialize=function(){QuestSystem.instance=this;let t=this;this.nowAnswer=-1,this.nowSelected=-1,this.qStart=-1,this.qEnd=-1,this.qNow=-1,this.btnPress[0].button.on("click",(function(e){for(let e=0;e<3;e++)t.btnSelected[e].enabled=!1;t.btnSelected[0].enabled=!0,t.nowSelected=0})),this.btnPress[1].button.on("click",(function(e){for(let e=0;e<3;e++)t.btnSelected[e].enabled=!1;t.btnSelected[1].enabled=!0,t.nowSelected=1})),this.btnPress[2].button.on("click",(function(e){for(let e=0;e<3;e++)t.btnSelected[e].enabled=!1;t.btnSelected[2].enabled=!0,t.nowSelected=2})),this.btnResultOK[0].button.on("click",(function(e){t.clearWindow()})),this.btnResultOK[1].button.on("click",(function(e){t.clearWindow()})),this.btnResultOK[2].button.on("click",(function(e){t.clearWindow()})),this.btnResultOK[3].button.on("click",(function(e){t.clearWindow()})),this.submit.button.on("click",(function(e){t.nowSelected==t.nowAnswer?t.NextQuestion():t.wrong.enabled=!0}))},QuestSystem.prototype.ShowQuest=function(t){this.qUse=t,this.qStart=3*t,this.qEnd=3*t+2,this.qNow=this.qStart;let e=QuestData.instance.quests[3*t];this.updateQuest(e),SceneManager.instance.s03.enabled=!1,SceneManager.instance.s04.enabled=!0},QuestSystem.prototype.NextQuestion=function(){if(this.qNow=this.qNow+1,this.qNow>this.qEnd)SceneManager.instance.s04.enabled=!1,GameSystem.instance.getItem(this.qUse);else{let t=QuestData.instance.quests[this.qNow];this.updateQuest(t)}},QuestSystem.prototype.updateQuest=function(t){this.title.element.text=t.title,this.subtitle.element.text=t.subtitle,this.content.element.text=t.q,this.a1.element.text=t.a0,this.a2.element.text=t.a1,this.a3.element.text=t.a2,this.nowAnswer=t.ans;for(let t=0;t<3;t++)this.btnSelected[t].enabled=!1;this.nowSelected=-1,this.wrong.enabled=!1},QuestSystem.prototype.clearWindow=function(){for(let t=0;t<4;t++)SceneManager.instance.s05[t].enabled=!1;GameSystem.instance.checkFusion(),GameSystem.instance.clearQuestion()},QuestSystem.prototype.update=function(t){};var SceneManager=pc.createScript("sceneManager");SceneManager.attributes.add("s01",{type:"entity"}),SceneManager.attributes.add("s02",{type:"entity"}),SceneManager.attributes.add("s03",{type:"entity"}),SceneManager.attributes.add("s04",{type:"entity"}),SceneManager.attributes.add("s05",{type:"entity",array:!0}),SceneManager.attributes.add("s06",{type:"entity"}),SceneManager.attributes.add("s07",{type:"entity"}),SceneManager.attributes.add("s08",{type:"entity"}),SceneManager.attributes.add("s09",{type:"entity"}),SceneManager.prototype.initialize=function(){SceneManager.instance=this,this.s01.enabled=!0,this.s02.enabled=!1,this.s03.enabled=!1,this.s04.enabled=!1,this.s05.enabled=!1,this.s06.enabled=!1,this.s07.enabled=!1,this.s08.enabled=!1,this.s09.enabled=!1},SceneManager.prototype.update=function(e){};var ImageTween=pc.createScript("imageTween");ImageTween.attributes.add("pos_tween",{type:"vec3"}),ImageTween.attributes.add("scale_tween",{type:"vec3"}),ImageTween.attributes.add("rotate_tween",{type:"boolean",default:!1}),ImageTween.attributes.add("duration",{type:"number",default:1}),ImageTween.prototype.initialize=function(){if(this.pos_tween.length()>0){let t=this.pos_tween.add(this.entity.getLocalPosition());this.entity.tween(this.entity.getLocalPosition()).to(t,this.duration,pc.QuadraticInOut).loop(!0).yoyo(!0).start()}if(this.scale_tween.length()>0){let t=this.scale_tween.add(this.entity.getLocalScale());this.entity.tween(this.entity.getLocalScale()).to(t,this.duration,pc.QuadraticInOut).loop(!0).yoyo(!0).start()}if(this.rotate_tween){let e=-360;var t={z:0};this.entity.tween(t).to({z:e},this.duration,pc.Linear).loop(!0).on("update",(function(){this.entity.setLocalEulerAngles(0,0,t.z)})).start()}},ImageTween.prototype.update=function(t){};pc.extend(pc,function(){var TweenManager=function(t){this._app=t,this._tweens=[],this._add=[]};TweenManager.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var i=0,e=this._tweens.length;i<e;)this._tweens[i].update(t)?i++:(this._tweens.splice(i,1),e--);this._add.length&&(this._tweens=this._tweens.concat(this._add),this._add.length=0)}};var Tween=function(t,i,e){pc.events.attach(this),this.manager=i,e&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.Linear,this._sv={},this._ev={}},_parseProperties=function(t){var i;return t instanceof pc.Vec2?i={x:t.x,y:t.y}:t instanceof pc.Vec3?i={x:t.x,y:t.y,z:t.z}:t instanceof pc.Vec4||t instanceof pc.Quat?i={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Color?(i={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(i.a=t.a)):i=t,i};Tween.prototype={to:function(t,i,e,n,s,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),n&&this.delay(n),s&&this.repeat(s),r&&this.yoyo(r),this},from:function(t,i,e,n,s,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),n&&this.delay(n),s&&this.repeat(s),r&&this.yoyo(r),this._from=!0,this},rotate:function(t,i,e,n,s,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),n&&this.delay(n),s&&this.repeat(s),r&&this.yoyo(r),this._slerp=!0,this},start:function(){var t,i,e,n;if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=this._delay>0,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this._properties[t],this._ev[t]=this.target[t]);this._slerp&&(this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,n=void 0!==this._properties.z?this._properties.z:this.target.z,this._fromQuat.setFromEulerAngles(i,e,n))}else{for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this.target[t],this._ev[t]=this._properties[t]);this._slerp&&(this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,n=void 0!==this._properties.z?this._properties.z:this.target.z,this._toQuat.setFromEulerAngles(i,e,n))}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,i){return this._count=0,this._numRepeats=t,this._repeatDelay=i||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)t>0?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time-=this._currentDelay,this.pending=!1}var i=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(i=this.duration-this.time,this.time=0):(i=this.time-this.duration,this.time=this.duration));var e,n,s=0===this.duration?1:this.time/this.duration,r=this.easing(s);for(var h in this._properties)this._properties.hasOwnProperty(h)&&(e=this._sv[h],n=this._ev[h],this.target[h]=e+(n-e)*r);if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,r),this.entity&&(this.entity._dirtifyLocal(),this.element&&this.entity.element&&(this.entity.element[this.element]=this.target),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(i);return a?this.fire("loop"):(this.fire("complete",i),this.entity&&this.entity.off("destroy",this.stop,this),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var i in this._properties){var e=this._sv[i];this._sv[i]=this._ev[i],this._ev[i]=e}this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var BounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},BounceIn=function(t){return 1-BounceOut(1-t)};return{TweenManager:TweenManager,Tween:Tween,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){var i=1.70158;return t*t*((i+1)*t-i)},BackOut:function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1},BackInOut:function(t){var i=2.5949095;return(t*=2)<1?t*t*((i+1)*t-i)*.5:.5*((t-=2)*t*((i+1)*t+i)+2)},BounceIn:BounceIn,BounceOut:BounceOut,BounceInOut:function(t){return t<.5?.5*BounceIn(2*t):.5*BounceOut(2*t-1)+.5},ElasticIn:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),-e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/.4))},ElasticOut:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),e*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var i,e=.1,n=.4;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=n*Math.asin(1/e)/(2*Math.PI),(t*=2)<1?e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/n)*-.5:e*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/n)*.5+1)}}}()),function(){pc.Application.prototype.addTweenManager=function(){this._tweenManager=new pc.TweenManager(this),this.on("update",(function(t){this._tweenManager.update(t)}))},pc.Application.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t,i){var e=this._app.tween(t);return e.entity=this,this.once("destroy",e.stop,e),i&&i.element&&(e.element=i.element),e};var t=pc.Application.getApplication();t&&t.addTweenManager()}();var PageTitle=pc.createScript("pageTitle");PageTitle.attributes.add("BTN_Start",{type:"entity"}),PageTitle.attributes.add("PL_Story",{type:"entity"}),PageTitle.attributes.add("BTN_Ready",{type:"entity"}),PageTitle.prototype.initialize=function(){let t=this;this.BTN_Start.button.on("click",(function(e){this.enabled=!1,t.BTN_Start.enabled=!1,t.PL_Story.enabled=!0})),this.BTN_Ready.button.on("click",(function(t){this.enabled=!1,SceneManager.instance.s01.enabled=!1,SceneManager.instance.s03.enabled=!0,GameSystem.instance.readyToScan=!0}))},PageTitle.prototype.update=function(t){};var TestQuest=pc.createScript("testQuest");TestQuest.attributes.add("BTN_track",{type:"entity",array:!0}),TestQuest.prototype.initialize=function(){this.BTN_track[0].button.on("click",(function(t){GameSystem.instance.showQuest(0)})),this.BTN_track[1].button.on("click",(function(t){GameSystem.instance.showQuest(1)})),this.BTN_track[2].button.on("click",(function(t){GameSystem.instance.showQuest(2)})),this.BTN_track[3].button.on("click",(function(t){GameSystem.instance.showQuest(3)}))},TestQuest.prototype.update=function(t){};var GameResult=pc.createScript("gameResult");GameResult.attributes.add("BTN_Fusion",{type:"entity"}),GameResult.attributes.add("BTN_Exchange",{type:"entity"}),GameResult.attributes.add("BTN_Confirm",{type:"entity"}),GameResult.attributes.add("BTN_Cancel",{type:"entity"}),GameResult.attributes.add("BTN_URL",{type:"entity"}),GameResult.prototype.initialize=function(){this.BTN_Fusion.button.on("click",(function(e){SceneManager.instance.s06.enabled=!1,SceneManager.instance.s07.enabled=!0})),this.BTN_Exchange.button.on("click",(function(e){SceneManager.instance.s08.enabled=!0})),this.BTN_Confirm.button.on("click",(function(e){SceneManager.instance.s08.enabled=!1,SceneManager.instance.s09.enabled=!0})),this.BTN_Cancel.button.on("click",(function(e){SceneManager.instance.s08.enabled=!1})),this.BTN_URL.button.on("click",(function(e){window.open("https://facebook.com")}))},GameResult.prototype.update=function(e){};